rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      match /game_lobbies/{gameLobbyId} {
        allow create: if canCreateGameLobby();
        allow read;
        allow update;
      }

      match /games/{gameId} {
        allow create: if canCreateGame();
        allow read;
        allow update;
      }

      match /games/{gameId}/boards/player_1 {
        allow write;
        allow read;
      }

      match /games/{gameId}/boards/player_2 {
        allow write;
        allow read;
      }

      function canCreateGame() {
        let gameLobbyId = request.resource.data.gameLobbyId;
        let createdValidLobby = existsAfter(/databases/$(database)/documents/game_lobbies/$(gameLobbyId));
        return createdValidLobby;
      }

      function canCreateGameLobby() {
        let gameId = request.resource.data.gameId;
        let createdValidGame = existsAfter(/databases/$(database)/documents/games/$(gameId));
        return createdValidGame
      }
    }
  }
}
